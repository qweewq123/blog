(window.webpackJsonp=window.webpackJsonp||[]).push([[12],{306:function(t,a,s){t.exports=s.p+"assets/img/medal.30debc27.gif"},307:function(t,a,s){t.exports=s.p+"assets/img/medaldemo.5ca39f9a.gif"},308:function(t,a,s){t.exports=s.p+"assets/img/runthreejs.946d8e8d.png"},309:function(t,a,s){t.exports=s.p+"assets/img/threejs.603cfc71.png"},324:function(t,a,s){"use strict";s.r(a);var n=[function(){var t=this,a=t.$createElement,n=t._self._c||a;return n("div",{staticClass:"content"},[n("h1",{attrs:{id:"网易公开课three-js实践-勋章系统"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#网易公开课three-js实践-勋章系统","aria-hidden":"true"}},[t._v("#")]),t._v(" 网易公开课Three.js实践 - 勋章系统")]),n("h2",{attrs:{id:"前言"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#前言","aria-hidden":"true"}},[t._v("#")]),t._v(" 前言")]),n("p",[n("strong",[t._v("WebGL")]),t._v("是一种3D绘图协议，这种绘图协议允许javascript和openGL结合起来。WebGL可以为canvas提供3d硬件加速（使用GPU在浏览器渲染3d模型和场景）。既然WebGL是openGL的一种实现，即可以在兼容的浏览器中进行3d渲染，由于浏览器的跨平台性，可以在多个设备多个平台展示3d效果。我们可以用WebGL做什么呢？")]),n("blockquote",[n("ol",[n("li",[n("ul",[n("li",[t._v("数据可视化")])])]),n("li",[n("ul",[n("li",[t._v("ar vr")])])]),n("li",[n("ul",[n("li",[t._v("3d游戏动画等\n在现代前端技术发展中，使用WebGL创建3d效果是一种不可获取的能力。由于webGL本身api是绘制最普通的点、线、三角形，所以为了绘制大型场景和模型，我们需要选用一些框架帮助开发，比如three.js。")])])])])]),n("p",[n("strong",[t._v("Three.js")]),t._v("是对WebGL的API抽象化和封装化的js库，不必关心WebGL怎么渲染3d图形，并且在渲染中加入了各种优化，提高了性能。Three.js包含数学库，支持交互，扩展性强，还可以进行SVG,CSS3D等渲染，在WebGL不兼容的版本可以有回退解决方案。下图是three.js对WebGL做的封装:")]),n("p",[n("img",{attrs:{src:s(309),alt:"image"}})]),n("h2",{attrs:{id:"勋章系统设计"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#勋章系统设计","aria-hidden":"true"}},[t._v("#")]),t._v(" 勋章系统设计")]),n("h4",{attrs:{id:"勋章系统开发选型"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#勋章系统开发选型","aria-hidden":"true"}},[t._v("#")]),t._v(" 勋章系统开发选型")]),n("p",[t._v("勋章系统是对用户粘性提升的一种积极刺激行为，分为样式展示(简单图片)--行为触发(达到某种条件)--颁发勋章(提供3d勋章)--勋章升级(不同等级勋章提供不同展示)--趣味性(移动端控制旋转特效)的一种逻辑。在勋章系统中有几个重点:")]),n("ul",[n("li",[t._v("1."),n("strong",[t._v("技术选型")]),t._v(" 因为是在app中展示，要考虑安卓和ios的差异性，还需要在web端展示效果，最好的选择就是用前端的WebGL方式来做3d勋章系统。在框架选择中，three.js的兼容性功能性都是接受过业界选择的，我们选择了three.js当我们的勋章系统框架。")]),n("li",[t._v("2."),n("strong",[t._v("模型选择")]),t._v(" 既然是3d勋章，3d模型的选择影响开发周期和渲染效果，调研了3d模型格式：")])]),n("table",[n("thead",[n("tr",[n("th",[t._v("Three.JS支持格式")]),n("th",[t._v("特点")]),n("th",[t._v("优缺点")])])]),n("tbody",[n("tr",[n("td",[t._v("JSON（*.js/ *.json）")]),n("td",[t._v("专门为Three.js自己设计的JSON格式，你可以使用它以声明的方式定义模型，及模型材质和动画。")]),n("td",[t._v("在app中的webview解析json比较慢")])]),n("tr",[n("td",[t._v("OBJ和MTL（*.obj/ *.mtl）")]),n("td",[t._v("OBJ是一种简单的三维文件格式，只用来定义对象的几何体。")]),n("td",[t._v("对象不支持动画，还需要搭配mtl来载入材质")])]),n("tr",[n("td",[t._v("Collada (*.dae)")]),n("td",[t._v("用来定义XML类文件中数字内容的格式。差不多所有的三维软件和渲染引擎都支持这个格式。")]),n("td",[t._v("使用最广，兼容性好")])]),n("tr",[n("td",[t._v("STL (*.stl)")]),n("td",[t._v("立体成型术 。 广泛用于快速成型。")]),n("td",[t._v("生成速度快，但是一般是3d打印机使用")])]),n("tr",[n("td",[t._v("FBX (*.fbx)")]),n("td",[t._v("在max、maya、softimage等软件间进行模型、材质、动作和摄影机信息的互导，复用性比较好。")]),n("td",[t._v("多平台支持，但是生成在部分平台会被转为mesh")])]),n("tr",[n("td",[t._v("CTM (*.ctm)")]),n("td",[t._v("由openCTM创建的格式。可以用来压缩存储表示三维网格的三角形面片。")]),n("td",[t._v("文件压缩效果好，压缩算法理解难度较高")])]),n("tr",[n("td",[t._v("VTK（*.vtk）")]),n("td",[t._v("Visualization Tookit定义的文件格式，用来指定顶点和面。")]),n("td",[t._v("可支持节点比较多，但threejs仅支持旧格式")])]),n("tr",[n("td",[t._v("PLY (*.ply)")]),n("td",[t._v("多边形文件格式。")]),n("td",[t._v("3d打印机使用")])])])]),n("p",[t._v("加上ui组使用c4d软件，最终选择了以xml为基础的dae的3d模型。")]),n("h4",{attrs:{id:"运行three-js"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#运行three-js","aria-hidden":"true"}},[t._v("#")]),t._v(" 运行Three.js")]),n("p",[t._v("Three.js是3d渲染，在3d渲染编程中包括：场景，相机，渲染器（物体，光源，纹理）。下图是three.js的运行过程：\n"),n("img",{attrs:{src:s(308),alt:"image"}})]),n("p",[t._v("要想使用three.js很简单，通过简单的js引用或者npm包下载即可。然后通过加载相应的解析模块，来载入个人模型或者控制器。")]),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v("'three'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v("'three/examples/js/loaders/ColladaLoader2'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v("'three/examples/js/loaders/MTLLoader'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),n("p",[t._v("在threejs中初始化场景，相机，灯光:")]),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("init")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n   "),n("span",{attrs:{class:"token function"}},[t._v("initRender")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n   "),n("span",{attrs:{class:"token function"}},[t._v("initScene")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n   "),n("span",{attrs:{class:"token function"}},[t._v("initCamera")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n   "),n("span",{attrs:{class:"token function"}},[t._v("initLight")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("p",[t._v("导入模型，并加载到场景:")]),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("loadModel")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n   mesh "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),n("span",{attrs:{class:"token class-name"}},[t._v("THREE"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Mesh")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n   "),n("span",{attrs:{class:"token keyword"}},[t._v("let")]),t._v(" mtl "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),n("span",{attrs:{class:"token class-name"}},[t._v("THREE"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("MTLLoader")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n   "),n("span",{attrs:{class:"token keyword"}},[t._v("let")]),t._v(" loader "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),n("span",{attrs:{class:"token class-name"}},[t._v("THREE"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ColladaLoader")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n   mtl"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("load")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"../model/yemaozi.mtl"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("result"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n       result"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("preload")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n       "),n("span",{attrs:{class:"token keyword"}},[t._v("let")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" materials "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" result\n       loader"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("load")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"../model/yemaozi.dae"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dae"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n           "),n("span",{attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token keyword"}},[t._v("let")]),t._v(" key "),n("span",{attrs:{class:"token keyword"}},[t._v("in")]),t._v(" dae"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("library"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("materials"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n               "),n("span",{attrs:{class:"token keyword"}},[t._v("let")]),t._v(" name "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" dae"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("library"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("materials"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("key"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("name\n               "),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("materials"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("name"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                   Object"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("assign")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dae"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("library"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("materials"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("key"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("build"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" materials"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("name"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n               "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n               "),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("name "),n("span",{attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v("'font'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                   dae"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("library"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("materials"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("key"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("build"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("blending "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{attrs:{class:"token constant"}},[t._v("THREE")]),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("NoBlending\n                   dae"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("library"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("materials"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("key"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("build"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("needsUpdate "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{attrs:{class:"token boolean"}},[t._v("true")]),t._v("\n               "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n           "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n           mesh "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" dae"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("scene"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("children"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{attrs:{class:"token number"}},[t._v("0")]),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("clone")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n           scene"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("add")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("mesh"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n       "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n   "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("p",[t._v("最后是最关键的渲染（包含动效）：")]),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{attrs:{class:"token comment"}},[t._v("// 动效")]),t._v("\n"),n("span",{attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("animate")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n   "),n("span",{attrs:{class:"token function"}},[t._v("requestAnimationFrame")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("animate"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n   mesh"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("rotation"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("y "),n("span",{attrs:{class:"token operator"}},[t._v("+=")]),n("span",{attrs:{class:"token number"}},[t._v("0.01")]),t._v("\n   "),n("span",{attrs:{class:"token function"}},[t._v("render")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("p",[t._v("展示效果如下：")]),n("p",[n("img",{attrs:{src:s(307),alt:"image"}})]),n("h2",{attrs:{id:"勋章系统优化"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#勋章系统优化","aria-hidden":"true"}},[t._v("#")]),t._v(" 勋章系统优化")]),n("blockquote",[n("p",[n("strong",[t._v("支持换肤功载")])])]),n("ul",[n("li",[t._v("多加入一个包含材质和纹理信息的mtl文件，通过不同的mtl材质提供换肤功能\n，通过接口返回的数据:")])]),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n   "),n("span",{attrs:{class:"token comment"}},[t._v("// 材质文件")]),t._v("\n   image3DMaterial"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v('"http://xxx.mtl"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n   "),n("span",{attrs:{class:"token comment"}},[t._v("// gzip压缩过的模型文件")]),t._v("\n   image3DMoudle"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v('"http://xxx.gz"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n   "),n("span",{attrs:{class:"token comment"}},[t._v("// 已获得图片")]),t._v("\n   imageGot"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v('"http://xxx.png"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n   "),n("span",{attrs:{class:"token comment"}},[t._v("// 未获得图片")]),t._v("\n   imageNotget"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v('"http://xxx.png"')]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("blockquote",[n("p",[n("strong",[t._v("生成模型文件较大，下载时间过长,并且cdn不支持gzip压缩")])])]),n("ul",[n("li",[t._v("出于体验优化,前端用nodejs写一个预压缩脚本，将dae和mtl文件压缩并上传到cdn同时同步更新到服务端的数据库中，解压通过webWorker多线程采用pako.js库进行gzip解压。")])]),n("blockquote",[n("p",[n("strong",[t._v("下载解析开销很大，并且3d模型占用内存过多")])])]),n("ul",[n("li",[n("p",[t._v("目前产品需求是只有等级5的勋章，分两步优化：")]),n("ul",[n("li",[t._v("内存中只会存储最近5次的解析过的模型,当有新的模型要加入，通过LRU策略，对于最长时间没有使用的模型内存会释放。")]),n("li",[t._v("数据会存在IndexedDB，每次请求先从内存读取，内存中不存在从IndexedDB读取,都不存在走网络请求，并且会把新数据通过key-value存入IndexedDB")])]),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{attrs:{class:"token comment"}},[t._v("// 尝试从临时缓存中读取模型")]),t._v("\n  "),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("models"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("currentMedalInfo"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("id"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    scene"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("add")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("models"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("currentMedalInfo"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("id"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    modelsList"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("splice")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("modelsList"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("findIndex")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("id"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("=>")]),t._v(" currentMedalInfo"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("id "),n("span",{attrs:{class:"token operator"}},[t._v("===")]),t._v(" id"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token number"}},[t._v("1")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    modelsList"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("push")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("currentMedalInfo"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("id"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{attrs:{class:"token function"}},[t._v("resolve")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{attrs:{class:"token keyword"}},[t._v("return")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n  "),n("span",{attrs:{class:"token keyword"}},[t._v("let")]),t._v(" medalDataMap"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" medalDataCache"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" modelData"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" materialData"),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("indexedDBSupport"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\n    medalDataMap "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("await")]),t._v(" localforage"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("getItem")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v("'medalDataMap'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    medalDataMap "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" medalDataMap "),n("span",{attrs:{class:"token operator"}},[t._v("||")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    medalDataCache "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" medalDataMap"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("currentMedalInfo"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("id"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("medalDataCache"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),n("span",{attrs:{class:"token comment"}},[t._v("// 如果材质地址没变则直接从indexedDB读取,否则清理掉")]),t._v("\n      "),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("medalDataCache"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("image3DMaterial "),n("span",{attrs:{class:"token operator"}},[t._v("===")]),t._v(" materialUrl"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        materialData "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("await")]),t._v(" localforage"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("getItem")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("materialUrl"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        localforage"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("removeItem")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("medalDataCache"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("image3DMaterial"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n      "),n("span",{attrs:{class:"token comment"}},[t._v("// 模型同上")]),t._v("\n      "),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("medalDataCache"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("image3DMoudle "),n("span",{attrs:{class:"token operator"}},[t._v("===")]),t._v(" modelUrl"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        modelData "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("await")]),t._v(" localforage"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("getItem")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("modelUrl"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        localforage"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("removeItem")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("medalDataCache"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("image3DMoudle"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),n("span",{attrs:{class:"token comment"}},[t._v("// 储存最新的信息")]),t._v("\n    medalDataMap"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("currentMedalInfo"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("id"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" currentMedalInfo"),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    localforage"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("setItem")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v("'medalDataMap'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" medalDataMap"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n  "),n("span",{attrs:{class:"token comment"}},[t._v("// 如果不支持或indexedDB中没有则加载")]),t._v("\n  "),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token operator"}},[t._v("!")]),t._v("materialData"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    materialData "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("loadResource")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" url"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" materialUrl "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token operator"}},[t._v("!")]),t._v("modelData"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    modelData "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("loadResource")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      url"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" modelUrl"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" type"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" isDae "),n("span",{attrs:{class:"token operator"}},[t._v("?")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v("'text'")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v("'arraybuffer'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" onProgress"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("progress"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("=>")]),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),n("span",{attrs:{class:"token function"}},[t._v("progressCB")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("progress"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("loaded "),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v(" progress"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("total "),n("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("isDae "),n("span",{attrs:{class:"token operator"}},[t._v("?")]),t._v(" "),n("span",{attrs:{class:"token number"}},[t._v("100")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token number"}},[t._v("80")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])])])]),n("blockquote",[n("p",[n("strong",[t._v("有些机型对WebGL支持不好,模型加载失败")])])]),n("ul",[n("li",[t._v("在获取数据时候，获得两张图片(没获得等级勋章和获得以后的勋章)，让2d图片当做优雅降级处理。")])]),n("blockquote",[n("p",[n("strong",[t._v("用户体验")])])]),n("ul",[n("li",[t._v("增加重力感应和粒子特效。")])]),n("blockquote",[n("p",[n("strong",[t._v("最终效果")])])]),n("p",[n("img",{attrs:{src:s(306),alt:"image"}})])])}],o=s(1),e=Object(o.a)({},function(){this.$createElement;this._self._c;return this._m(0)},n,!1,null,null,null);a.default=e.exports}}]);