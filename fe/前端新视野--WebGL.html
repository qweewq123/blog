<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>网易公开课Three.js实践 - 勋章系统 | wdss博客</title>
    <meta name="description" content="wdss blog">
    
    
    <link rel="preload" href="/blog/assets/css/0.styles.cea2a1f0.css" as="style"><link rel="preload" href="/blog/assets/js/app.1dc3aeb8.js" as="script"><link rel="preload" href="/blog/assets/js/12.37ae4b82.js" as="script"><link rel="prefetch" href="/blog/assets/js/1.25384c06.js"><link rel="prefetch" href="/blog/assets/js/2.9edb8b66.js"><link rel="prefetch" href="/blog/assets/js/3.94701dc3.js"><link rel="prefetch" href="/blog/assets/js/4.33bb7f70.js"><link rel="prefetch" href="/blog/assets/js/5.60339f1a.js"><link rel="prefetch" href="/blog/assets/js/6.e8680e03.js"><link rel="prefetch" href="/blog/assets/js/7.2343cfe2.js"><link rel="prefetch" href="/blog/assets/js/8.0565515c.js"><link rel="prefetch" href="/blog/assets/js/9.493a9d7c.js"><link rel="prefetch" href="/blog/assets/js/10.4b8b9c11.js"><link rel="prefetch" href="/blog/assets/js/11.6ecb7356.js"><link rel="prefetch" href="/blog/assets/js/13.d427d3b6.js"><link rel="prefetch" href="/blog/assets/js/14.d1f916f5.js"><link rel="prefetch" href="/blog/assets/js/15.96d856a7.js"><link rel="prefetch" href="/blog/assets/js/16.69bed0e7.js"><link rel="prefetch" href="/blog/assets/js/17.664b09db.js"><link rel="prefetch" href="/blog/assets/js/18.99f18d8d.js"><link rel="prefetch" href="/blog/assets/js/19.0418ee98.js"><link rel="prefetch" href="/blog/assets/js/20.076b8660.js"><link rel="prefetch" href="/blog/assets/js/21.51b28580.js"><link rel="prefetch" href="/blog/assets/js/22.52ff61e9.js"><link rel="prefetch" href="/blog/assets/js/23.391786e6.js"><link rel="prefetch" href="/blog/assets/js/24.8d2ed051.js"><link rel="prefetch" href="/blog/assets/js/25.a71b792d.js"><link rel="prefetch" href="/blog/assets/js/26.3875498a.js"><link rel="prefetch" href="/blog/assets/js/27.69ede453.js"><link rel="prefetch" href="/blog/assets/js/28.4f20574b.js"><link rel="prefetch" href="/blog/assets/js/29.5c718e17.js"><link rel="prefetch" href="/blog/assets/js/30.5e8e9a29.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.cea2a1f0.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/blog/" class="home-link router-link-active"><!----><span class="site-name">
      wdss博客
    </span></a><div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div><nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">首页</a></div><div class="nav-item"><a href="/blog/fe/" class="nav-link router-link-active">前端之路</a></div><div class="nav-item"><a href="/blog/ai/" class="nav-link">算法和AI</a></div><div class="nav-item"><a href="/blog/full/" class="nav-link">全栈工程师</a></div><div class="nav-item"><a href="https://qweewq123.github.io/resume/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  个人简历
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/qweewq123" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><!----></nav></div></header><div class="sidebar-mask"></div><div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">首页</a></div><div class="nav-item"><a href="/blog/fe/" class="nav-link router-link-active">前端之路</a></div><div class="nav-item"><a href="/blog/ai/" class="nav-link">算法和AI</a></div><div class="nav-item"><a href="/blog/full/" class="nav-link">全栈工程师</a></div><div class="nav-item"><a href="https://qweewq123.github.io/resume/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  个人简历
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/qweewq123" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><!----></nav><ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading"><span>html</span><!----></p><ul class="sidebar-group-items"><li><a href="/blog/fe/页面重绘和回流以及优化.html" class="sidebar-link">页面重绘和回流以及优化</a></li><li><a href="/blog/fe/如何计算白屏和首屏时间.html" class="sidebar-link">如何计算白屏和首屏时间</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>css</span><!----></p><ul class="sidebar-group-items"><li><a href="/blog/fe/flex.html" class="sidebar-link">flex布局</a></li><li><a href="/blog/fe/FC.html" class="sidebar-link">FC(formatting context)</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading open"><span>js</span><!----></p><ul class="sidebar-group-items"><li><a href="/blog/fe/set.html" class="sidebar-link">set</a></li><li><a href="/blog/fe/前端模块化.html" class="sidebar-link">前端模块化</a></li><li><a href="/blog/fe/arguments.html" class="sidebar-link">arguments</a></li><li><a href="/blog/fe/防抖和节流.html" class="sidebar-link">防抖和节流</a></li><li><a href="/blog/fe/promise.html" class="sidebar-link">promise的实现</a></li><li><a href="/blog/fe/setTimeout妙用.html" class="sidebar-link">setTimeout妙用</a></li><li><a href="/blog/fe/深入理解javascript中的原型.html" class="sidebar-link">深入理解javascript中的原型</a></li><li><a href="/blog/fe/前端新视野--WebGL.html" class="active sidebar-link">网易公开课Three.js实践 - 勋章系统</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/fe/前端新视野--WebGL.html#前言" class="sidebar-link">前言</a></li><li class="sidebar-sub-header"><a href="/blog/fe/前端新视野--WebGL.html#勋章系统设计" class="sidebar-link">勋章系统设计</a></li><li class="sidebar-sub-header"><a href="/blog/fe/前端新视野--WebGL.html#勋章系统优化" class="sidebar-link">勋章系统优化</a></li></ul></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>vue</span><!----></p><ul class="sidebar-group-items"><li><a href="/blog/fe/使用nuxt的ssr渲染.html" class="sidebar-link">使用nuxt的ssr渲染</a></li><li><a href="/blog/fe/vue学习watch的高级用法.html" class="sidebar-link">vue学习watch的高级用法</a></li><li><a href="/blog/fe/渲染函数.html" class="sidebar-link">渲染函数</a></li><li><a href="/blog/fe/vue生命周期.html" class="sidebar-link">vue生命周期</a></li><li><a href="/blog/fe/vue-router.html" class="sidebar-link">vue-router知识</a></li><li><a href="/blog/fe/vue提高大型数据列表的性能.html" class="sidebar-link">vue提高大型数据列表的性能</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>其他</span><!----></p><ul class="sidebar-group-items"><li><a href="/blog/fe/hack.html" class="sidebar-link">hack</a></li><li><a href="/blog/fe/web安全.html" class="sidebar-link">web安全</a></li></ul></div></li></ul></div><div class="page"><div class="content"><h1 id="网易公开课three-js实践-勋章系统"><a href="#网易公开课three-js实践-勋章系统" aria-hidden="true" class="header-anchor">#</a> 网易公开课Three.js实践 - 勋章系统</h1><h2 id="前言"><a href="#前言" aria-hidden="true" class="header-anchor">#</a> 前言</h2><p><strong>WebGL</strong>是一种3D绘图协议，这种绘图协议允许javascript和openGL结合起来。WebGL可以为canvas提供3d硬件加速（使用GPU在浏览器渲染3d模型和场景）。既然WebGL是openGL的一种实现，即可以在兼容的浏览器中进行3d渲染，由于浏览器的跨平台性，可以在多个设备多个平台展示3d效果。我们可以用WebGL做什么呢？</p><blockquote><ol><li><ul><li>数据可视化</li></ul></li><li><ul><li>ar vr</li></ul></li><li><ul><li>3d游戏动画等
在现代前端技术发展中，使用WebGL创建3d效果是一种不可获取的能力。由于webGL本身api是绘制最普通的点、线、三角形，所以为了绘制大型场景和模型，我们需要选用一些框架帮助开发，比如three.js。</li></ul></li></ol></blockquote><p><strong>Three.js</strong>是对WebGL的API抽象化和封装化的js库，不必关心WebGL怎么渲染3d图形，并且在渲染中加入了各种优化，提高了性能。Three.js包含数学库，支持交互，扩展性强，还可以进行SVG,CSS3D等渲染，在WebGL不兼容的版本可以有回退解决方案。下图是three.js对WebGL做的封装:</p><p><img src="/blog/assets/img/threejs.603cfc71.png" alt="image"></p><h2 id="勋章系统设计"><a href="#勋章系统设计" aria-hidden="true" class="header-anchor">#</a> 勋章系统设计</h2><h4 id="勋章系统开发选型"><a href="#勋章系统开发选型" aria-hidden="true" class="header-anchor">#</a> 勋章系统开发选型</h4><p>勋章系统是对用户粘性提升的一种积极刺激行为，分为样式展示(简单图片)--行为触发(达到某种条件)--颁发勋章(提供3d勋章)--勋章升级(不同等级勋章提供不同展示)--趣味性(移动端控制旋转特效)的一种逻辑。在勋章系统中有几个重点:</p><ul><li>1.<strong>技术选型</strong> 因为是在app中展示，要考虑安卓和ios的差异性，还需要在web端展示效果，最好的选择就是用前端的WebGL方式来做3d勋章系统。在框架选择中，three.js的兼容性功能性都是接受过业界选择的，我们选择了three.js当我们的勋章系统框架。</li><li>2.<strong>模型选择</strong> 既然是3d勋章，3d模型的选择影响开发周期和渲染效果，调研了3d模型格式：</li></ul><table><thead><tr><th>Three.JS支持格式</th><th>特点</th><th>优缺点</th></tr></thead><tbody><tr><td>JSON（*.js/ *.json）</td><td>专门为Three.js自己设计的JSON格式，你可以使用它以声明的方式定义模型，及模型材质和动画。</td><td>在app中的webview解析json比较慢</td></tr><tr><td>OBJ和MTL（*.obj/ *.mtl）</td><td>OBJ是一种简单的三维文件格式，只用来定义对象的几何体。</td><td>对象不支持动画，还需要搭配mtl来载入材质</td></tr><tr><td>Collada (*.dae)</td><td>用来定义XML类文件中数字内容的格式。差不多所有的三维软件和渲染引擎都支持这个格式。</td><td>使用最广，兼容性好</td></tr><tr><td>STL (*.stl)</td><td>立体成型术 。 广泛用于快速成型。</td><td>生成速度快，但是一般是3d打印机使用</td></tr><tr><td>FBX (*.fbx)</td><td>在max、maya、softimage等软件间进行模型、材质、动作和摄影机信息的互导，复用性比较好。</td><td>多平台支持，但是生成在部分平台会被转为mesh</td></tr><tr><td>CTM (*.ctm)</td><td>由openCTM创建的格式。可以用来压缩存储表示三维网格的三角形面片。</td><td>文件压缩效果好，压缩算法理解难度较高</td></tr><tr><td>VTK（*.vtk）</td><td>Visualization Tookit定义的文件格式，用来指定顶点和面。</td><td>可支持节点比较多，但threejs仅支持旧格式</td></tr><tr><td>PLY (*.ply)</td><td>多边形文件格式。</td><td>3d打印机使用</td></tr></tbody></table><p>加上ui组使用c4d软件，最终选择了以xml为基础的dae的3d模型。</p><h4 id="运行three-js"><a href="#运行three-js" aria-hidden="true" class="header-anchor">#</a> 运行Three.js</h4><p>Three.js是3d渲染，在3d渲染编程中包括：场景，相机，渲染器（物体，光源，纹理）。下图是three.js的运行过程：
<img src="/blog/assets/img/runthreejs.946d8e8d.png" alt="image"></p><p>要想使用three.js很简单，通过简单的js引用或者npm包下载即可。然后通过加载相应的解析模块，来载入个人模型或者控制器。</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token string">'three'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">'three/examples/js/loaders/ColladaLoader2'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">'three/examples/js/loaders/MTLLoader'</span><span class="token punctuation">;</span>
</code></pre></div><p>在threejs中初始化场景，相机，灯光:</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token function">initRender</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token function">initScene</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token function">initCamera</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token function">initLight</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>导入模型，并加载到场景:</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">loadModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   mesh <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>Mesh</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token keyword">let</span> mtl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>MTLLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token keyword">let</span> loader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>ColladaLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   mtl<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token string">&quot;../model/yemaozi.mtl&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       result<span class="token punctuation">.</span><span class="token function">preload</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
       <span class="token keyword">let</span> <span class="token punctuation">{</span> materials <span class="token punctuation">}</span> <span class="token operator">=</span> result
       loader<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token string">&quot;../model/yemaozi.dae&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>dae<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> dae<span class="token punctuation">.</span>library<span class="token punctuation">.</span>materials<span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token keyword">let</span> name <span class="token operator">=</span> dae<span class="token punctuation">.</span>library<span class="token punctuation">.</span>materials<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>name
               <span class="token keyword">if</span> <span class="token punctuation">(</span>materials<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                   Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>dae<span class="token punctuation">.</span>library<span class="token punctuation">.</span>materials<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>build<span class="token punctuation">,</span> materials<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span>
               <span class="token punctuation">}</span>
               <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">===</span> <span class="token string">'font'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                   dae<span class="token punctuation">.</span>library<span class="token punctuation">.</span>materials<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>build<span class="token punctuation">.</span>blending <span class="token operator">=</span> <span class="token constant">THREE</span><span class="token punctuation">.</span>NoBlending
                   dae<span class="token punctuation">.</span>library<span class="token punctuation">.</span>materials<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>build<span class="token punctuation">.</span>needsUpdate <span class="token operator">=</span> <span class="token boolean">true</span>
               <span class="token punctuation">}</span>
           <span class="token punctuation">}</span>
           mesh <span class="token operator">=</span> dae<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
           scene<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>mesh<span class="token punctuation">)</span>
       <span class="token punctuation">}</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token punctuation">}</span>
</code></pre></div><p>最后是最关键的渲染（包含动效）：</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 动效</span>
<span class="token keyword">function</span> <span class="token function">animate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>animate<span class="token punctuation">)</span>
   mesh<span class="token punctuation">.</span>rotation<span class="token punctuation">.</span>y <span class="token operator">+=</span><span class="token number">0.01</span>
   <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>展示效果如下：</p><p><img src="/blog/assets/img/medaldemo.5ca39f9a.gif" alt="image"></p><h2 id="勋章系统优化"><a href="#勋章系统优化" aria-hidden="true" class="header-anchor">#</a> 勋章系统优化</h2><blockquote><p><strong>支持换肤功载</strong></p></blockquote><ul><li>多加入一个包含材质和纹理信息的mtl文件，通过不同的mtl材质提供换肤功能
，通过接口返回的数据:</li></ul><div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
   <span class="token comment">// 材质文件</span>
   image3DMaterial<span class="token punctuation">:</span> <span class="token string">&quot;http://xxx.mtl&quot;</span><span class="token punctuation">,</span>
   <span class="token comment">// gzip压缩过的模型文件</span>
   image3DMoudle<span class="token punctuation">:</span> <span class="token string">&quot;http://xxx.gz&quot;</span><span class="token punctuation">,</span>
   <span class="token comment">// 已获得图片</span>
   imageGot<span class="token punctuation">:</span> <span class="token string">&quot;http://xxx.png&quot;</span><span class="token punctuation">,</span>
   <span class="token comment">// 未获得图片</span>
   imageNotget<span class="token punctuation">:</span> <span class="token string">&quot;http://xxx.png&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p><strong>生成模型文件较大，下载时间过长,并且cdn不支持gzip压缩</strong></p></blockquote><ul><li>出于体验优化,前端用nodejs写一个预压缩脚本，将dae和mtl文件压缩并上传到cdn同时同步更新到服务端的数据库中，解压通过webWorker多线程采用pako.js库进行gzip解压。</li></ul><blockquote><p><strong>下载解析开销很大，并且3d模型占用内存过多</strong></p></blockquote><ul><li><p>目前产品需求是只有等级5的勋章，分两步优化：</p><ul><li>内存中只会存储最近5次的解析过的模型,当有新的模型要加入，通过LRU策略，对于最长时间没有使用的模型内存会释放。</li><li>数据会存在IndexedDB，每次请求先从内存读取，内存中不存在从IndexedDB读取,都不存在走网络请求，并且会把新数据通过key-value存入IndexedDB</li></ul><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 尝试从临时缓存中读取模型</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>models<span class="token punctuation">[</span>currentMedalInfo<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    scene<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>models<span class="token punctuation">[</span>currentMedalInfo<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    modelsList<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>modelsList<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> currentMedalInfo<span class="token punctuation">.</span>id <span class="token operator">===</span> id<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    modelsList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>currentMedalInfo<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">let</span> medalDataMap<span class="token punctuation">,</span> medalDataCache<span class="token punctuation">,</span> modelData<span class="token punctuation">,</span> materialData<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>indexedDBSupport<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    medalDataMap <span class="token operator">=</span> <span class="token keyword">await</span> localforage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">'medalDataMap'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    medalDataMap <span class="token operator">=</span> medalDataMap <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    medalDataCache <span class="token operator">=</span> medalDataMap<span class="token punctuation">[</span>currentMedalInfo<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>medalDataCache<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果材质地址没变则直接从indexedDB读取,否则清理掉</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>medalDataCache<span class="token punctuation">.</span>image3DMaterial <span class="token operator">===</span> materialUrl<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        materialData <span class="token operator">=</span> <span class="token keyword">await</span> localforage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span>materialUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        localforage<span class="token punctuation">.</span><span class="token function">removeItem</span><span class="token punctuation">(</span>medalDataCache<span class="token punctuation">.</span>image3DMaterial<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 模型同上</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>medalDataCache<span class="token punctuation">.</span>image3DMoudle <span class="token operator">===</span> modelUrl<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        modelData <span class="token operator">=</span> <span class="token keyword">await</span> localforage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span>modelUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        localforage<span class="token punctuation">.</span><span class="token function">removeItem</span><span class="token punctuation">(</span>medalDataCache<span class="token punctuation">.</span>image3DMoudle<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 储存最新的信息</span>
    medalDataMap<span class="token punctuation">[</span>currentMedalInfo<span class="token punctuation">.</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> currentMedalInfo<span class="token punctuation">;</span>
    localforage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">'medalDataMap'</span><span class="token punctuation">,</span> medalDataMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 如果不支持或indexedDB中没有则加载</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>materialData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    materialData <span class="token operator">=</span> <span class="token function">loadResource</span><span class="token punctuation">(</span><span class="token punctuation">{</span> url<span class="token punctuation">:</span> materialUrl <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>modelData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    modelData <span class="token operator">=</span> <span class="token function">loadResource</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      url<span class="token punctuation">:</span> modelUrl<span class="token punctuation">,</span> type<span class="token punctuation">:</span> isDae <span class="token operator">?</span> <span class="token string">'text'</span> <span class="token punctuation">:</span> <span class="token string">'arraybuffer'</span><span class="token punctuation">,</span> onProgress<span class="token punctuation">:</span> <span class="token punctuation">(</span>progress<span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        <span class="token function">progressCB</span><span class="token punctuation">(</span>progress<span class="token punctuation">.</span>loaded <span class="token operator">/</span> progress<span class="token punctuation">.</span>total <span class="token operator">*</span> <span class="token punctuation">(</span>isDae <span class="token operator">?</span> <span class="token number">100</span> <span class="token punctuation">:</span> <span class="token number">80</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div></li></ul><blockquote><p><strong>有些机型对WebGL支持不好,模型加载失败</strong></p></blockquote><ul><li>在获取数据时候，获得两张图片(没获得等级勋章和获得以后的勋章)，让2d图片当做优雅降级处理。</li></ul><blockquote><p><strong>用户体验</strong></p></blockquote><ul><li>增加重力感应和粒子特效。</li></ul><blockquote><p><strong>最终效果</strong></p></blockquote><p><img src="/blog/assets/img/medal.30debc27.gif" alt="image"></p></div><div class="page-edit"><!----><!----></div><!----></div></div></div>
    <script src="/blog/assets/js/12.37ae4b82.js" defer></script><script src="/blog/assets/js/app.1dc3aeb8.js" defer></script>
  </body>
</html>
